<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte interactive ‚Äì CA & Commerciaux</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: #fff; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { padding: 12px 16px; display: flex; gap: 12px; align-items: center; border-bottom: 1px solid #eee; flex-wrap: wrap; }
    header .title { font-weight: 700; }
    header .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    select, input[type="text"] { padding: 6px 8px; border: 1px solid #ccc; border-radius: 10px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f0f0f0; font-size: 12px; }
    #map { height: 100%; width: 100%; background: #fff; }
    .legend { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,.08); line-height: 1.2; }
    .info { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,.08); }
    .tooltip h4 { margin: 0 0 6px 0; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="title">üìç Carte France ‚Äì CA & Commerciaux</div>
      <div class="controls">
        <label>Mode couleur
          <select id="colorMode">
            <option value="ca" selected>CA (‚Ç¨)</option>
            <option value="coverage">Commercial</option>
          </select>
        </label>
        <label>Commercial
          <select id="repFilter">
            <option value="ALL">Tous</option>
          </select>
        </label>
        <input id="search" type="text" placeholder="Rechercher un d√©partement‚Ä¶ (nom ou code)" />
      </div>
    </header>
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    const DATA = {"01": {"pharmacies": 159, "ca": 103490.0, "commercial": "Charlotte Degournay, Odile Lenot"}, "02": {"pharmacies": 171, "ca": 1309.0, "commercial": "S. Gambirasio"}, "03": {"pharmacies": 134, "ca": 16541.0, "commercial": null}, "04": {"pharmacies": 59, "ca": 127063.0, "commercial": "Geraldine Seliga, Laure Bonnel, Laurent Botti, S. Gambirasio, Vincent Guinet"}, "05": {"pharmacies": 55, "ca": 152062.0, "commercial": "Laurent Botti"}, "06": {"pharmacies": 439, "ca": 695500.0, "commercial": "Geraldine Seliga"}, "07": {"pharmacies": 97, "ca": 87876.0, "commercial": "Olivier Seon, S. Gambirasio, Vincent Guinet"}, "08": {"pharmacies": 105, "ca": 16625.0, "commercial": "Sophie Hocquard"}, "09": {"pharmacies": 48, "ca": 67339.0, "commercial": "Agnes Tafforin"}, "10": {"pharmacies": 89, "ca": 0, "commercial": null}, "11": {"pharmacies": 137, "ca": 300489.0, "commercial": "Caroline Jofre"}, "12": {"pharmacies": 112, "ca": 35902.0, "commercial": "Vincent Guinet"}, "13": {"pharmacies": 745, "ca": 2063658.0, "commercial": "Bernadette Boiron, Laure Bonnel, Laurent Botti, Nathalie Bouchard, S. Gambirasio, Val Barnes, Vincent Guinet"}, "14": {"pharmacies": 215, "ca": 20394.0, "commercial": null}, "15": {"pharmacies": 66, "ca": 53077.0, "commercial": null}, "16": {"pharmacies": 124, "ca": 0, "commercial": null}, "17": {"pharmacies": 222, "ca": 677.0, "commercial": "Caroline Jofre, S. Gambirasio"}, "18": {"pharmacies": 104, "ca": 0, "commercial": null}, "19": {"pharmacies": 97, "ca": 4209.0, "commercial": null}, "20": {"pharmacies": 138, "ca": 166540.0, "commercial": "Laure Bonnel, Nathalie Bouchard"}, "21": {"pharmacies": 168, "ca": 0, "commercial": null}, "22": {"pharmacies": 196, "ca": 0, "commercial": null}, "23": {"pharmacies": 56, "ca": 0, "commercial": null}, "24": {"pharmacies": 141, "ca": 0, "commercial": null}, "25": {"pharmacies": 183, "ca": 67652.0, "commercial": "Josee Muth"}, "26": {"pharmacies": 154, "ca": 105301.0, "commercial": "Olivier Seon, Vincent Guinet"}, "27": {"pharmacies": 146, "ca": 0, "commercial": null}, "28": {"pharmacies": 107, "ca": 0, "commercial": null}, "29": {"pharmacies": 298, "ca": 0, "commercial": null}, "30": {"pharmacies": 249, "ca": 539414.0, "commercial": "Bernadette Boiron, Vincent Guinet"}, "31": {"pharmacies": 409, "ca": 286458.0, "commercial": "Agnes Tafforin"}, "32": {"pharmacies": 64, "ca": 10380.0, "commercial": "Agnes Tafforin"}, "33": {"pharmacies": 528, "ca": 221.0, "commercial": "S. Gambirasio"}, "34": {"pharmacies": 391, "ca": 512241.0, "commercial": "Bernadette Boiron, Caroline Jofre, Vincent Guinet"}, "35": {"pharmacies": 300, "ca": 0, "commercial": null}, "36": {"pharmacies": 86, "ca": 0, "commercial": null}, "37": {"pharmacies": 197, "ca": 0, "commercial": null}, "38": {"pharmacies": 379, "ca": 413734.0, "commercial": "Charlotte Degournay, Olivier Seon"}, "39": {"pharmacies": 91, "ca": 0, "commercial": null}, "40": {"pharmacies": 133, "ca": 0, "commercial": null}, "41": {"pharmacies": 103, "ca": 0, "commercial": null}, "42": {"pharmacies": 228, "ca": 102573.0, "commercial": "Odile Lenot"}, "43": {"pharmacies": 82, "ca": 22329.0, "commercial": null}, "44": {"pharmacies": 400, "ca": 549.0, "commercial": "S. Gambirasio"}, "45": {"pharmacies": 186, "ca": 0, "commercial": null}, "46": {"pharmacies": 64, "ca": 2947.0, "commercial": null}, "47": {"pharmacies": 123, "ca": 0, "commercial": null}, "48": {"pharmacies": 34, "ca": 42982.0, "commercial": "Vincent Guinet"}, "49": {"pharmacies": 240, "ca": 964.0, "commercial": null}, "50": {"pharmacies": 138, "ca": 0, "commercial": null}, "51": {"pharmacies": 184, "ca": 23477.0, "commercial": "Sophie Hocquard"}, "52": {"pharmacies": 60, "ca": 1829.0, "commercial": "S. Gambirasio"}, "53": {"pharmacies": 84, "ca": 0, "commercial": null}, "54": {"pharmacies": 262, "ca": 53401.0, "commercial": "Sophie Hocquard"}, "55": {"pharmacies": 58, "ca": 27990.0, "commercial": "Sophie Hocquard"}, "56": {"pharmacies": 239, "ca": 0, "commercial": null}, "57": {"pharmacies": 259, "ca": 160911.0, "commercial": "Sophie Hocquard"}, "58": {"pharmacies": 80, "ca": 0, "commercial": null}, "59": {"pharmacies": 896, "ca": 101605.0, "commercial": "Anne Decroix"}, "60": {"pharmacies": 217, "ca": 1332.0, "commercial": "Christophe Marthoud"}, "61": {"pharmacies": 93, "ca": 0, "commercial": null}, "62": {"pharmacies": 502, "ca": 121003.0, "commercial": "Anne Decroix"}, "63": {"pharmacies": 240, "ca": 153186.0, "commercial": null}, "64": {"pharmacies": 247, "ca": 2257.0, "commercial": "Geraldine Seliga, S. Gambirasio"}, "65": {"pharmacies": 93, "ca": 0, "commercial": null}, "66": {"pharmacies": 171, "ca": 287415.0, "commercial": "Caroline Jofre"}, "67": {"pharmacies": 281, "ca": 136907.0, "commercial": "Josee Muth"}, "68": {"pharmacies": 192, "ca": 216547.0, "commercial": "Josee Muth"}, "69": {"pharmacies": 558, "ca": 178094.0, "commercial": "Odile Lenot, Olivier Seon"}, "70": {"pharmacies": 82, "ca": 0, "commercial": null}, "71": {"pharmacies": 191, "ca": 140515.0, "commercial": "Odile Lenot"}, "72": {"pharmacies": 160, "ca": 0, "commercial": null}, "73": {"pharmacies": 148, "ca": 102324.0, "commercial": "Charlotte Degournay"}, "74": {"pharmacies": 226, "ca": 148715.0, "commercial": "Charlotte Degournay"}, "75": {"pharmacies": 883, "ca": 9061.0, "commercial": "Christophe Marthoud, S. Gambirasio"}, "76": {"pharmacies": 358, "ca": 0, "commercial": null}, "77": {"pharmacies": 356, "ca": 184363.0, "commercial": "Christophe Marthoud"}, "78": {"pharmacies": 380, "ca": 149.0, "commercial": "Christophe Marthoud, S. Gambirasio"}, "79": {"pharmacies": 124, "ca": 0, "commercial": null}, "80": {"pharmacies": 191, "ca": 4648.0, "commercial": null}, "81": {"pharmacies": 126, "ca": 61722.0, "commercial": "Agnes Tafforin"}, "82": {"pharmacies": 78, "ca": 13410.0, "commercial": "Agnes Tafforin"}, "83": {"pharmacies": 372, "ca": 1403294.0, "commercial": "Geraldine Seliga, Laurent Botti, Nathalie Bouchard, S. Gambirasio"}, "84": {"pharmacies": 203, "ca": 583439.0, "commercial": "Laure Bonnel, S. Gambirasio, Vincent Guinet"}, "85": {"pharmacies": 212, "ca": 0, "commercial": null}, "86": {"pharmacies": 145, "ca": 0, "commercial": null}, "87": {"pharmacies": 152, "ca": 0, "commercial": null}, "88": {"pharmacies": 131, "ca": 0, "commercial": null}, "89": {"pharmacies": 105, "ca": 0, "commercial": null}, "90": {"pharmacies": 51, "ca": 31156.0, "commercial": "Josee Muth"}, "91": {"pharmacies": 347, "ca": 1381.0, "commercial": "Christophe Marthoud"}, "92": {"pharmacies": 463, "ca": 3020.0, "commercial": "Christophe Marthoud"}, "93": {"pharmacies": 402, "ca": 63071.0, "commercial": "Christophe Marthoud"}, "94": {"pharmacies": 395, "ca": 49644.0, "commercial": "Christophe Marthoud"}, "95": {"pharmacies": 322, "ca": 40982.0, "commercial": "Christophe Marthoud"}, "98": {"pharmacies": 700, "ca": 29026.0, "commercial": "Geraldine Seliga"}, "97": {"pharmacies": 0, "ca": 1927.0, "commercial": "S. Gambirasio"}, "X": {"pharmacies": 0, "ca": 1719.0, "commercial": null}};

    const GEOJSON_URL = "https://france-geojson.gregoiredavid.fr/repo/departements.geojson";

    const map = L.map('map', { minZoom: 5, maxZoom: 10 });

    const infoCtrl = L.control({position: 'topright'});
    infoCtrl.onAdd = function () { this._div = L.DomUtil.create('div', 'info'); this.update(); return this._div; };
    infoCtrl.update = function (props) {
      this._div.innerHTML = props ? `
        <div class="tooltip">
          <h4>${props.nom} (${props.code})</h4>
          <div>Pharmacies : ${props.pharmacies||0}</div>
          <div>CA : ${Intl.NumberFormat('fr-FR',{notation:'compact', maximumFractionDigits:1}).format(props.ca||0)}</div>
          <div>Commercial : <span class="badge">${props.commercial || 'Non affect√©'}</span></div>
        </div>` : 'Survolez un d√©partement';
    };
    infoCtrl.addTo(map);

    const legendCtrl = L.control({position: 'bottomright'});
    legendCtrl.onAdd = function () { this._div = L.DomUtil.create('div', 'legend'); return this._div; };
    legendCtrl.addTo(map);

    function colorCA(v){
      if (v < 20000) return '#ddd';
      if (v < 100000) return '#d9f2d9';
      if (v < 200000) return '#66cc66';
      return '#1a781a';
    }

    const COVERAGE_COLORS = { full: '#2ca02c', partial: '#ff7f0e', none: '#d3d3d3' };
    function coverageOf(d){
      if (d.commercial) return 'full';
      if ((d.ca||0) > 0) return 'partial';
      return 'none';
    }

    function enrichProps(feat){
      let code = feat.properties.code;
      let rec = DATA[code];
      if (!rec && (code === '2A' || code === '2B') && DATA['20']) {
        rec = DATA['20'];
      }
      if (!rec) rec = { pharmacies: 0, ca: 0, commercial: null };
      return { code, nom: feat.properties.nom, ...rec };
    }

    let geoLayer;
    fetch(GEOJSON_URL)
      .then(r=>r.json())
      .then(geojson => {
        geoLayer = L.geoJSON(geojson, {
          style: baseStyle,
          onEachFeature: (feat, layer) => {
            const d = enrichProps(feat);
            layer.on({ mouseover: (e)=>highlight(e, d), mouseout: resetHighlight, click: (e)=>map.fitBounds(e.target.getBounds(), { maxZoom: 8 }) });
            layer.bindTooltip(()=>tooltipHTML(d), { sticky: true, direction: 'top' });
          }
        }).addTo(map);
        const b = geoLayer.getBounds();
        map.fitBounds(b);
        map.setMaxBounds(b.pad(0.05));
        populateRepFilter();
        recolor();
      })
      .catch(err => alert('Erreur de chargement GeoJSON: '+err));

    function baseStyle(){ return { color: '#666', weight: 1, fillOpacity: 0.9 }; }
    function highlight(e, d){ e.target.setStyle({ weight: 2, color: '#000' }); infoCtrl.update(d); }
    function resetHighlight(e){ geoLayer.resetStyle(e.target); infoCtrl.update(); }

    function tooltipHTML(d){
      return `
        <div class="tooltip">
          <h4>${d.nom} (${d.code})</h4>
          <div>Pharmacies : <strong>${d.pharmacies}</strong></div>
          <div>CA : <strong>${Intl.NumberFormat('fr-FR').format(d.ca)}</strong></div>
          <div>Commercial : <span class="badge">${d.commercial || 'Non affect√©'}</span></div>
        </div>`;
    }

    function recolor(){
      const repSel = document.getElementById('repFilter').value;
      const colorMode = document.getElementById('colorMode').value;

      if (colorMode === 'coverage') {
        geoLayer.eachLayer(layer => {
          const d = enrichProps(layer.feature);
          const passRep = repSel === 'ALL' ? true : (repSel === 'UNASSIGNED' ? !d.commercial : d.commercial === repSel);
          const cov = coverageOf(d);
          const fill = passRep ? (COVERAGE_COLORS[cov] || '#ccc') : '#ddd';
          layer.setStyle({ fillColor: fill, fillOpacity: passRep ? 0.9 : 0.35 });
        });
        legendCtrl._div.innerHTML = `
          <strong>Couverture</strong><br>
          <div><span style="background:${COVERAGE_COLORS.full};display:inline-block;width:14px;height:14px;margin-right:4px"></span> Couvert</div>
          <div><span style="background:${COVERAGE_COLORS.partial};display:inline-block;width:14px;height:14px;margin-right:4px"></span> Partiel</div>
          <div><span style="background:${COVERAGE_COLORS.none};display:inline-block;width:14px;height:14px;margin-right:4px"></span> Non couvert</div>`;
        return;
      }

      geoLayer.eachLayer(layer => {
        const d = enrichProps(layer.feature);
        const passRep = repSel === 'ALL' ? true : (repSel === 'UNASSIGNED' ? !d.commercial : d.commercial === repSel);
        const fill = passRep ? colorCA(d.ca||0) : '#ddd';
        layer.setStyle({ fillColor: fill, fillOpacity: passRep ? 0.9 : 0.35 });
      });
      legendCtrl._div.innerHTML = `
        <strong>CA (‚Ç¨)</strong><br>
        <div><span style="background:#ddd;display:inline-block;width:14px;height:14px;margin-right:4px"></span> &lt; 20k (non color√©)</div>
        <div><span style="background:#d9f2d9;display:inline-block;width:14px;height:14px;margin-right:4px"></span> 20k ‚Äì 100k</div>
        <div><span style="background:#66cc66;display:inline-block;width:14px;height:14px;margin-right:4px"></span> 100k ‚Äì 200k</div>
        <div><span style="background:#1a781a;display:inline-block;width:14px;height:14px;margin-right:4px"></span> &gt; 200k</div>
      `;
    }

    function populateRepFilter(){
      const reps = new Set();
      Object.values(DATA).forEach(r => { if(r.commercial) reps.add(r.commercial); });
      const sel = document.getElementById('repFilter');
      sel.innerHTML = '<option value="ALL">Tous</option>' +
                      '<option value="UNASSIGNED">Non affect√©</option>' +
                      Array.from(reps).sort().map(r=>`<option value="${r}">${r}</option>`).join('');
    }

    document.getElementById('colorMode').addEventListener('change', recolor);
    document.getElementById('repFilter').addEventListener('change', recolor);
    document.getElementById('search').addEventListener('keyup', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      if(!q) return;
      let found;
      geoLayer.eachLayer(layer => {
        const p = layer.feature.properties;
        if(p.nom.toLowerCase().includes(q) || p.code.toLowerCase() === q){ found = layer; }
      });
      if(found){ map.fitBounds(found.getBounds(), { maxZoom: 8 }); found.fire('mouseover'); }
    });
  </script>
</body>
</html>
